Лабораторная работа – Создание и тестирование сертификатов
В рамках данной лабораторной работы мы создадим запрос на сертификат домена consist-os.csr, корневой УЦ, промежуточный УЦ, а также добавим корневой сертификат в доверенные и протестируем его, используя средства библиотеки openssl. 

    1. Для начала создадим CSR заявителя, для этого сперва сгенерируем закрытый ключ заявителя в формате rsa: openssl genrsa -out rsa2048.pem 2048
    2. Затем создадим запрос на сертификат: openssl req -new -key rsa2048.pem -out consist.csr
    3. В интерактивном режиме вводим следующие параметры:
Country Name:RU
State or Province Name:Moscow region
Locality Name (eg, city) []:Moscow
Organization Name (eg, company) []: AO Consist-os
Organizational Unit Name (eg, section) []: central office AO Consist-os
Common Name (eg, fully qualified host name) []:www.consist-os.ru
Email Address []:info@consist-os.ru
Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:1234
An optional company name []: CO
    4. Для просмотра созданного CSR сертификата используем следующую команду:
openssl asn1parse -dump -i -in consist.csr
    5. Создадим сертификат корневого удостоверяющего центра
openssl genrsa -out ca-root.key 2048
openssl req -new -x509 -batch -days 1000 -key ca-root.key -subj  '/C=AQ/O=Amaze Corp. ./CN= Root CA' -out ca-root.crt
    6. Создадим сертификат промежуточного УЦ
        6.1 Создание закрытого ключа: openssl genpkey -algorithm rsa -pkeyopt rsa_keygen_bits:2048 -out ca-inter.key
        6.2 CSR. 
openssl req -new -batch -key ca-inter.key  -subj '/C=RU/L=SaintPetersburg/CN=Intermediate Authority' -out ca-inter.csr
6.3 Создаём файл ca-inter.cnf с параметрами расширений, которые мы хотим включить в сертификат:
	[cert_ext]
	authorityKeyIdentifier = keyid
	subjectKeyIdentifier = hash
	basicConstraints = critical, CA:true
	keyUsage = digitalSignature, keyCertSign
        6.4 Создание промежуточного сертификата из всего вышеперечисленного
openssl x509 -req -in ca-inter.csr -days 365 -CA ca-root.crt -CAkey ca-root.key -CAcreateserial -extfile ca-inter.cnf -extensions cert_ext -out ca-inter.crt

    7. Создание сертификата consist-os из промежуточного
7.1. Создаём файл с параметрами расширений (consist.cnf)
[cert_ext]
	authorityKeyIdentifier = keyid
	basicConstraints = critical, CA:false
	subjectAltName = DNS:consist-os.ru, DNS:www. consist-os.ru 
	keyUsage = digitalSignature
7.2 Подписываем сертификат сайта промежуточным удостоверяющим центром:
openssl x509 -req -in consist.csr -days 365 -CA ca-inter.crt -CAkey ca-inter.key -CAcreateserial -extfile consist.cnf -extensions cert_ext -out consist.crt
    8. Проверка сертификатов на TLS-сервере
        8.1 Поднимаем сервер
openssl s_server -accept 127.0.0.1:9443 -key rsa2048.pem -cert consist.crt -cert_chain ca-inter.crt
        8.2 Запускаем в отдельной вкладке терминала клиент для проверки соединения: 
openssl s_client -connect 127.0.0.1:9443 -no-CApath -CAfile ca-root.crt -servername www.consist-os.ru -quiet
        8.3 Подключение клиента без указания корневого сертификата:
openssl s_client -connect 127.0.0.1:9443 -no-CApath -servername www.consist-os.ru -quiet
    9. Добавление корневого сертификата в Chromium/Chrome
9.1. На панели инструментов нажать кнопку с тремя вертикальными точками – настройки – Конфиденциальность и безопасность – Безопасность – Настроить сертификаты – Центры сертификации – Кнопка «Импорт» и выбрать корневой сертификат
9.2. Далее необходимо прервать сессию клиента нажав Ctrl+C
10. После ввода https//127.0.0.1:9443 в браузере в терминале сервера должно вывести

	В браузере ввода https//127.0.0.1:9443



Информация по аргументам:

Пояснения по аргументам для самоподписанного сертификата коревого УЦ:
-req
указывает, что на вход в аргументе -in ожидается именно Certificate Signing Request;
-days 365
выписываем сертификат на 365 дней;
-CA -CAkey 
указываем сертификат и закрытый ключ УЦ, из сертификата будет взято поле subject и вставлено в итоговой сертификат в поле issuer;
-CAcreateserial
это означает, что будет создан файл с именем ca-root.srl, в который будет записан серийный номер сертификата, а дальше openssl из этого файла возьмёт значение и запишет в сертификат, про серийный номер я уже писал выше в теоретическом разделе, это должно быть число, уникальное для каждого сертификата, подписанного конкретным сертификатом УЦ. В реальном удостоверяющем центре ведётся реестр выписанных сертификатов и для каждого создаётся собственный уникальный serialNumber. Вы можете создать файл ca-root.srl самостоятельно и прописать туда любое число. При каждом запуске команды создания сертификата на базе CSR значение в этом файле увеличивается на единицу. Если файла нет и аргумент -CAcreateserial не указан, то openssl выдаст ошибку. Если файл уже существует, то аргумент -CAcreateserial игнорируется.
-extfile ca-inter.cnf
Путь к файлу с параметрами расширений.
-extensions cert_ext
Название секции в файле, где собственно и записаны параметры расширений.

Пояснение к файлу расширений сайта консиста:
authorityKeyIdentifier = keyid
Идентификатор ключа удостоверяющего центра автоматически берётся из расширения Subject Key Identifier того сертификата, которым подписываем данный, то есть из ca-inter.crt.
basicConstraints = critical, CA:false
УЦ явным образом запрещает создаваемый сертификат использовать для подписывания других сертификатов. Кроме того, значение помечено как критическое.
subjectAltName = DNS:consist-os.ru, DNS:www. consist-os.ru
Перечисляем все дополнительные записи-identity, которые мы хотим добавить в сертификат
keyUsage = digitalSignature
Разрешаем использование сертификата для проверки цифровой подписи.

11 Дополнительно. Верификация цепочки сертификатов
Для верификации сертификата вам нужна цепочка доверия, завершающаяся корневым сертификатом.
cat ca-inter.crt ca-root.crt > chain.pem
openssl verify -no-CApath -CAfile chain.pem consist.crt
consist.crt: OK

Без построения цепочки:
openssl verify -no-CApath -CAfile ca-inter.crt -partial_chain consist.crt

12 Дополнительно. Подпись любых файлов с помощью цифровой подписи
12.1 Генерация цифровой подписи для файла промежуточного сертификата:
openssl dgst -sha256 -sign rsa2048.pem -out ca-inter.crt.sig ca-inter.crt
12.1 Выделяем открытый ключ из сертификата
openssl x509 -in consist.crt -pubkey -noout > consist-pubkey.pem
12.2 Верифицируем файл ca-inter.crt, используя цифровую подпись и выделенный только что открытый ключ:
openssl dgst -sha256 -verify consist-pubkey.pem -signature ca-inter.sig ca-inter.crt
Результат - Verified OK
